# Coordinate Sync Quick Reference

## Problem

PDF coordinates don't match the `.aux` file (the source of truth).

## Solution

Use the sync script to regenerate coordinate files directly from the aux file:

```bash
make sync-aux AUX=TeX/document.aux
```

## Commands

### Sync Coordinates

```bash
# Basic sync (outputs to same directory as aux file)
make sync-aux AUX=TeX/ENDEND10921-generated.aux

# Sync to specific output directory (e.g., ui/)
make sync-aux AUX=TeX/ENDEND10921-generated.aux OUTDIR=ui

# Direct script usage with options
node scripts/external/sync_from_aux.js TeX/document.aux --output-dir ui --force
```

### Verify Coordinates

```bash
# Verify coordinates match aux file
./scripts/external/verify_coords.sh TeX/document.aux

# Will show:
# - Sample coordinate comparisons
# - Match/mismatch status
# - Summary of records found
```

### Complete Workflow

```bash
# 1. Generate PDF with LaTeX (3 passes for accuracy)
lualatex -output-directory=TeX document.tex
lualatex -output-directory=TeX document.tex
lualatex -output-directory=TeX document.tex

# 2. Sync coordinates from aux
make sync-aux AUX=TeX/document.aux OUTDIR=ui

# 3. Copy PDF to UI directory
cp TeX/document.pdf ui/

# 4. View in browser
open ui/index.html
```

## What Gets Generated

### Input
- `TeX/document.aux` - Contains precise coordinates from LaTeX

### Outputs
- `TeX/document-texpos.ndjson` - Raw coordinates in NDJSON format
- `TeX/document-marked-boxes.json` - Processed bounding boxes with multiple units

## Coordinate Format Examples

### AUX File (source)
```tex
\zref@newlabel{gm:sec-p-002:P-start}{\posx{3729359}\posy{30964035}\page{1}}
```
- `xsp`: 3729359 (x in scaled points)
- `ysp`: 30964035 (y in scaled points)  
- `page`: 1

### NDJSON (intermediate)
```json
{"id":"sec-p-002","role":"P-start","xsp":"3729359","ysp":"30964035","page":1,...}
```

### Marked Boxes (final)
```json
{
  "id": "sec-p-002",
  "page": 1,
  "x_pt": 56.91,
  "y_pt": 372.57,
  "w_pt": 235.85,
  "h_pt": 30.88,
  "x_mm": 20.08,
  "y_mm": 131.44,
  ...
}
```

## Coordinate Conversions

```
Scaled Points → Points:    pt = sp ÷ 65536
TeX Y → PDF Y:            pdf_y = page_height - tex_y
Points → Millimeters:      mm = pt × 0.352778
Points → Pixels (72 DPI):  px = pt × 1
```

## Common Issues

### "Incomplete pair" warnings
**Cause:** Element spans multiple pages or LaTeX compilation incomplete

**Solution:** Run LaTeX 3 times, then sync again

### "Duplicate records removed"
**Normal:** Aux file may have multiple entries from different runs

**Behavior:** Sync keeps the LAST (most recent) occurrence

### Coordinates still don't match
**Cause:** Need to resync after LaTeX changes

**Solution:** 
1. Recompile LaTeX (3 times)
2. Run sync again: `make sync-aux AUX=...`

## Why This Works

| Method | Source | Lag | Accuracy |
|--------|--------|-----|----------|
| **Normal LaTeX compilation** | Previous aux | 1 cycle | ~99% |
| **Sync from aux** | Current aux | None | 100% ✓ |

The aux file is written by LaTeX with exact coordinates. The sync script reads directly from it, ensuring perfect accuracy.

## File Locations

```
prototype-pdf-object-overlay/
├── TeX/
│   ├── document.aux                    ← SOURCE OF TRUTH
│   ├── document-texpos.ndjson         ← Generated by sync
│   └── document-marked-boxes.json     ← Generated by sync
├── ui/
│   ├── document.pdf                    ← Copy manually
│   └── document-marked-boxes.json     ← Copy or sync directly
└── scripts/external/
    ├── sync_from_aux.js               ← Sync script
    └── verify_coords.sh               ← Verification script
```

## Integration with Makefile

The sync is integrated into the Makefile for easy use:

```makefile
# In Makefile
sync-aux:
    @node scripts/external/sync_from_aux.js $(AUX) --force
```

Usage:
```bash
make sync-aux AUX=path/to/file.aux [OUTDIR=output/dir]
```

## Help

```bash
# Show sync script help
node scripts/external/sync_from_aux.js --help

# Show verification script help
./scripts/external/verify_coords.sh

# Show Makefile help
make help
```

## Documentation

- **Detailed Guide:** [docs/AUX-SYNC-GUIDE.md](AUX-SYNC-GUIDE.md)
- **Implementation:** [docs/COORDINATE-SYNC-SOLUTION.md](COORDINATE-SYNC-SOLUTION.md)
- **Main README:** [README.md](../README.md)

## Quick Copy-Paste Commands

```bash
# Standard workflow with sync
cd /path/to/project
lualatex -output-directory=TeX TeX/document.tex  # Run 3 times
make sync-aux AUX=TeX/document.aux OUTDIR=ui
cp TeX/document.pdf ui/
open ui/index.html

# Verify coordinates
./scripts/external/verify_coords.sh TeX/document.aux

# Check for duplicates in aux
grep 'gm:element-id:' TeX/document.aux
```

---

**TL;DR**: After generating PDF, run `make sync-aux AUX=TeX/document.aux` to ensure 100% coordinate accuracy from the aux file.

