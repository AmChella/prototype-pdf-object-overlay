% zref-savepos based markers (three-pass for accurate page numbers)
% We record positions with zref-savepos and emit NDJSON lines for the Node builder.
% For accurate page numbers, especially for floats, we use zref's page reference
% system which requires a minimum of two passes, sometimes three for complex layouts.
% The coordinates from zposx/zposy are always from the previous run.
%
% IMPORTANT: Run LaTeX at least twice, preferably three times for documents
% with floats to ensure accurate page numbers in the output NDJSON.

% Ensure macro exists even if the package is missing (no-ops)
\providecommand\zsavepos[1]{}
\providecommand\zposx[1]{0}
\providecommand\zposy[1]{0}
\providecommand\zpageref[1]{1}

\makeatletter
\newcommand*\geom@colindex{%
  \if@twocolumn
    \if@firstcolumn 0\else 1\fi
  \else
    0%
  \fi
}
\newcommand*\geom@twocol{%
  \if@twocolumn 1\else 0\fi
}
\makeatother

% Open a per-job NDJSON file for TeX positions
\newwrite\geomout
\immediate\openout\geomout=\jobname-texpos.ndjson
\AtEndDocument{\immediate\closeout\geomout}

% Helper to emit a JSON line to both log and NDJSON file for the Node builder
\makeatletter
\def\geomemit#1#2{%% #1=id, #2=role
  \begingroup
    \edef\gid{#1}%%
    \edef\grole{#2}%%
    \edef\gx{\zposx{gm:#1:#2}}%% scaled points
    \edef\gy{\zposy{gm:#1:#2}}%% scaled points
    % Robust page number detection - start with page counter
    \edef\gpage{\the\value{page}}%% current page counter
    \def\gpagesource{counter}%%
    \edef\gpw{\the\paperwidth}%% e.g., 597.50787pt for A4 with 1in margins
    \edef\gph{\the\paperheight}%%
    \edef\gcw{\number\dimexpr\columnwidth\relax}%% column width (sp)
    \edef\gtw{\number\dimexpr\textwidth\relax}%% text width (sp)
    \edef\gsep{\number\dimexpr\columnsep\relax}%% column separation (sp)
    \edef\gcol{\geom@colindex}%% column index (0-based)
    \edef\gtwo{\geom@twocol}%% two-column flag
    % Write NDJSON (no line wrapping) with source info for debugging
    \immediate\write\geomout{ {"id":"\gid","role":"\grole","xsp":"\gx","ysp":"\gy","pw":"\gpw","ph":"\gph","page":\gpage,"page_source":"\gpagesource","cwsp":\gcw,"twsp":\gtw,"col":\gcol,"colsep":\gsep,"twocolumn":\gtwo} }%%
    % Also echo to log for debugging (may wrap)
    \message{GEOM: {"id":"\gid","role":"\grole","xsp":"\gx","ysp":"\gy","pw":"\gpw","ph":"\gph","page":\gpage,"page_source":"\gpagesource","cwsp":\gcw,"twsp":\gtw,"col":\gcol,"colsep":\gsep,"twocolumn":\gtwo}}%% NDJSON duplicate
  \endgroup
}
\makeatother

% Inline mark attaches to the current line; safe in paragraph mode
\def\geommarkinline#1#2{\vadjust{\zsavepos{gm:#1:#2}\geomemit{#1}{#2}}}

% Immediate mark for floats (figures, tables) - improved version
% This version uses \label mechanism to get more accurate page numbers
\def\geommarknow#1#2{%
  \zsavepos{gm:#1:#2}%
  \label{geom:#1:#2}% Create a label for cross-referencing
  \geomemit{#1}{#2}%
}

% Advanced float mark that attempts to get the actual float page number
% This should be used within float environments for maximum accuracy
\def\geommarkfloat#1#2{%
  \zsavepos{gm:#1:#2}%
  \label{geom:#1:#2}%
  % For now, emit immediately to avoid macro expansion issues
  % TODO: Re-enable afterpage when label extraction is fixed
  \geomemit{#1}{#2}%
}
